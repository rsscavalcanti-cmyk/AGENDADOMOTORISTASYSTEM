<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda do Motorista ‚Äî v4 (auto‚Äëupdate + origem/destino)</title>
  <!-- Evita cache agressivo em p√°ginas est√°ticas -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:16px}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:14px}
    @media(min-width:1024px){.grid.cols-3{grid-template-columns:2fr 1.1fr 1.1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .panel h2{margin:0 0 10px;font-size:15px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 190px}
    input, select, textarea{width:100%;background:#0b1224;border:1px solid var(--border);color:var(--text);padding:9px 10px;border-radius:10px;outline:none}
    textarea{min-height:70px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#0b1224;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#0ea5e9}
    .btn.ghost{background:transparent}
    .right{display:flex;gap:8px;align-items:center}
    .table-wrap{max-height:440px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{background:#0b1224;position:sticky;top:0;z-index:1}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
    .u-baixa{background:#0b3b1f;color:#c7f9cc}.u-media{background:#3a3000;color:#fde68a}.u-alta{background:#3a1400;color:#fdba74}.u-critical{background:#3a0000;color:#fecaca}
    .muted{color:var(--muted)}
    .counter{font-size:28px;font-weight:800}
    .card{background:#0b1224;border:1px solid var(--border);border-radius:12px;padding:12px}
    .list{display:grid;gap:6px}
    .item{display:flex;justify-content:space-between;gap:10px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .scrollbox{max-height:180px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0b1224}
    .scrollbox .pill{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;margin:4px 0;border:1px solid #1f2937;border-radius:10px;cursor:pointer}
    .pill small{opacity:.8}
    .toast{position:fixed;right:14px;bottom:14px;background:#0b1224;border:1px solid var(--border);padding:10px 12px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <h1>Agenda do Motorista ‚Äî v4</h1>
    <div class="right">
      <small id="version" class="muted"></small>
      <button class="btn ghost" id="btn-reload" title="Recarregar">‚Üª Recarregar</button>
      <button class="btn" id="btn-export">‚¨áÔ∏è Exportar</button>
      <label class="btn" title="Importar JSON">‚¨ÜÔ∏è Importar<input type="file" id="file-import" accept="application/json" hidden></label>
      <button class="btn" id="btn-reset">üóëÔ∏è Limpar</button>
    </div>
  </header>

  <div class="wrap grid cols-3">
    <!-- Formul√°rio -->
    <section class="panel" id="form-panel">
      <h2>Novo pedido / corrida</h2>
      <div class="row">
        <div>
          <label>Data/Hora Solicita√ß√£o</label>
          <input type="datetime-local" id="f_created_at" />
        </div>
        <div>
          <label>Solicitante</label>
          <input id="f_requester" list="catalog-requesters" placeholder="Ex.: Marcelo" />
          <datalist id="catalog-requesters"></datalist>
        </div>
        <div>
          <label>Urg√™ncia</label>
          <select id="f_urgency"><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option><option value="critical">CRITICAL</option></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label><strong>Origem</strong></label>
          <input id="f_origin" list="catalog-locations" placeholder="Ex.: Escrit√≥rio System" />
        </div>
        <div>
          <label><strong>Destino</strong></label>
          <input id="f_destination" list="catalog-locations" placeholder="Ex.: Atl√¢ntico Golf ‚Äî Bloco 3" />
        </div>
        <div>
          <label>Janela/Limite</label>
          <input type="datetime-local" id="f_deadline" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Observa√ß√µes</label>
          <textarea id="f_notes" placeholder="Materiais especiais, acesso, protocolo‚Ä¶"></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Status</label>
          <select id="f_status"><option value="pendente">Pendente</option><option value="agendado">Agendado</option><option value="em_rota">Em rota</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select>
        </div>
        <div class="right"><button class="btn primary" id="btn-add">‚ûï Adicionar</button></div>
      </div>
      <p class="muted">Dica: clique em um item dos cat√°logos para preencher os campos. Origem e Destino s√£o obrigat√≥rios.</p>
    </section>

    <!-- Resumo & Filtros -->
    <section class="panel" id="summary-panel">
      <h2>Resumo</h2>
      <div class="row">
        <div class="card"><div class="muted">Corridas hoje</div><div id="m_today" class="counter">0</div></div>
        <div class="card"><div class="muted">Pendentes</div><div id="m_pending" class="counter">0</div></div>
        <div class="card"><div class="muted">Urgentes</div><div id="m_hot" class="counter">0</div></div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div><label>Per√≠odo ‚Äî In√≠cio</label><input type="date" id="flt_from" /></div>
        <div><label>Per√≠odo ‚Äî Fim</label><input type="date" id="flt_to" /></div>
      </div>
      <div class="row">
        <div><label>Solicitante (cont√©m)</label><input id="flt_requester" /></div>
        <div><label>Origem (cont√©m)</label><input id="flt_origin" /></div>
        <div><label>Destino (cont√©m)</label><input id="flt_destination" /></div>
      </div>
      <div class="row">
        <div><label>Urg√™ncia</label><select id="flt_urgency"><option value="">Todas</option><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option><option value="critical">CRITICAL</option></select></div>
        <div><label>Status</label><select id="flt_status"><option value="">Todos</option><option value="pendente">Pendente</option><option value="agendado">Agendado</option><option value="em_rota">Em rota</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select></div>
      </div>
    </section>

    <!-- Cat√°logos -->
    <section class="panel" id="catalogs">
      <h2>Cat√°logos (rolagem)</h2>
      <div class="sep"></div>
      <div class="row">
        <div>
          <div class="muted" style="margin-bottom:6px">Nomes mais comuns que requisitam</div>
          <div class="scrollbox" id="box-requesters"></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Locais mais comuns</div>
          <div class="scrollbox" id="box-locations"></div>
        </div>
      </div>
    </section>

    <!-- Tabela principal -->
    <section class="panel" style="grid-column:1 / -1">
      <h2>Solicita√ß√µes / Corridas</h2>
      <div class="table-wrap"><table>
        <thead><tr>
          <th style="min-width:160px">Data/Hora</th>
          <th style="min-width:160px">Solicitante</th>
          <th style="min-width:200px">Origem</th>
          <th style="min-width:220px">Destino</th>
          <th>Urg√™ncia</th>
          <th>Janela/Limite</th>
          <th style="min-width:220px">Observa√ß√µes</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr></thead>
        <tbody id="tbl"></tbody>
      </table></div>
    </section>
  </div>

  <!-- ======== Configura√ß√£o de pr√©-carga ======== -->
  <script id="preload-data" type="application/json">{ "version": 4, "requests": [] }</script>
  <script>
  // ========= AUTO-UPDATE ROBUSTO =========
  const APP_VERSION = 'v4.0.0';               // incremente a cada altera√ß√£o do c√≥digo
  const LS_APP_VER = 'agendaMotorista_appv';  // chave para versionamento no navegador
  const LS_KEY = 'agendaMotorista_v4';        // chave de dados
  const PRELOAD_URL = 'agenda-motorista-17-09.json'; // opcional ‚Äî arquivo no repo

  // Mostra vers√£o na UI
  document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('version').textContent = APP_VERSION; });

  // 1) Service Worker m√≠nimo (network-first) para evitar cache velho
  if('serviceWorker' in navigator){
    const swCode = `self.addEventListener('install',e=>{self.skipWaiting()});self.addEventListener('activate',e=>{self.clients.claim()});self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request,{cache:'no-store'}).catch(()=>caches.match(e.request)))})`;
    const blob = new Blob([swCode],{type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }

  // 2) Bump de vers√£o: se o APP_VERSION mudou, limpamos dados antigos e recarregamos 1x
  (function enforceVersion(){
    const cur = localStorage.getItem(LS_APP_VER);
    if(cur !== APP_VERSION){
      localStorage.setItem(LS_APP_VER, APP_VERSION);
      // N√£o apagamos backups; apenas os dados ativos para for√ßar re-sync
      localStorage.removeItem(LS_KEY);
      // dispara uma recarga suave ap√≥s pequeno atraso para pegar o arquivo novo
      setTimeout(()=>location.reload(), 150);
    }
  })();

  // ======== App ========
  const $ = (q, el=document)=>el.querySelector(q);
  const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
  const fmtDateTime = v => v? new Date(v).toLocaleString('pt-BR'): '';
  const todayStr = () => new Date().toISOString().slice(0,10);

  const CATALOG_REQUESTERS = ['Sigrid','Marcelo Gosling','Maria','Daniele Abreu','Cristiane','Renato','Suprimentos','Samuel','Departamento administrativo','Outros (por observa√ß√£o)'];
  const CATALOG_LOCATIONS = ['Atl√¢ntico Golf','Safra','Iconyc','Orygem','Galp√£o','Banco','Escrit√≥rio System','Galp√£o logistico System','Outros (especificar)'];

  let data = null;

  (async function init(){
    data = await boot();
    buildCatalogs();
    bindEvents();
    renderAll();
  })();

  async function boot(){
    const fromLS = load();
    if(fromLS && Array.isArray(fromLS.requests)) return fromLS;
    // Tenta JSON externo (com cache bust)
    if(PRELOAD_URL){
      try{ const res = await fetch(`${PRELOAD_URL}?v=${encodeURIComponent(APP_VERSION)}`, {cache:'no-store'}); if(res.ok){ const j = await res.json(); if(j && Array.isArray(j.requests)){ localStorage.setItem(LS_KEY, JSON.stringify(j)); return j; } } }catch{ }
    }
    // Tenta JSON embutido
    try{ const raw = document.getElementById('preload-data')?.textContent||''; if(raw.trim()){ const j = JSON.parse(raw); if(j && Array.isArray(j.requests)){ localStorage.setItem(LS_KEY, JSON.stringify(j)); return j; } } }catch{}
    // Fallback demo
    const seeded = seed(); localStorage.setItem(LS_KEY, JSON.stringify(seeded)); return seeded;
  }

  function bindEvents(){
    $('#btn-add').addEventListener('click', onAdd);
    $('#btn-reset').addEventListener('click', ()=>{ if(confirm('Limpar dados locais e recarregar?')){ localStorage.removeItem(LS_KEY); location.reload(); } });
    $('#btn-export').addEventListener('click', onExport);
    $('#file-import').addEventListener('change', onImport);
    $('#btn-reload').addEventListener('click', ()=>location.reload());
    $$('#summary-panel input, #summary-panel select').forEach(el=> el.addEventListener('input', renderAll));
  }

  function buildCatalogs(){
    const boxR = $('#box-requesters'); const boxL = $('#box-locations');
    const dlR = $('#catalog-requesters'); const dlL = $('#catalog-locations');
    boxR.innerHTML = boxL.innerHTML = dlR.innerHTML = dlL.innerHTML = '';
    for(const n of CATALOG_REQUESTERS){
      const div = document.createElement('div'); div.className='pill'; div.innerHTML = `<span>${escapeHtml(n)}</span><small>usar</small>`; div.addEventListener('click',()=>{ $('#f_requester').value=n; $('#f_requester').focus();}); boxR.appendChild(div);
      const opt = document.createElement('option'); opt.value=n; dlR.appendChild(opt);
    }
    for(const l of CATALOG_LOCATIONS){
      const div = document.createElement('div'); div.className='pill'; div.innerHTML = `<span>${escapeHtml(l)}</span><small>usar</small>`; div.addEventListener('click',()=>{ if(!$('#f_origin').value) $('#f_origin').value=l; else $('#f_destination').value=l;}); boxL.appendChild(div);
      const opt = document.createElement('option'); opt.value=l; dlL.appendChild(opt);
    }
  }

  function onAdd(){
    const item = { id: crypto.randomUUID(), created_at: $('#f_created_at').value || new Date().toISOString(), requester_name: ($('#f_requester').value||'').trim(), urgency: $('#f_urgency').value, origin: ($('#f_origin').value||'').trim(), destination: ($('#f_destination').value||'').trim(), deadline_at: $('#f_deadline').value || null, notes: ($('#f_notes').value||'').trim(), status: $('#f_status').value };
    if(!item.requester_name || !item.origin || !item.destination){ alert('Solicitante, Origem e Destino s√£o obrigat√≥rios.'); return; }
    data.requests.unshift(item); save(); clearForm(); renderAll(); toast('Corrida adicionada.');
  }

  function onExport(){ const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='agenda-motorista.json'; a.click(); URL.revokeObjectURL(url); }
  function onImport(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const p=JSON.parse(r.result); if(!p||!Array.isArray(p.requests)) throw new Error('JSON inv√°lido'); data=p; save(); renderAll(); toast('Dados importados.'); }catch(err){ alert('Falha ao importar: '+err.message) } }; r.readAsText(f); }

  function renderAll(){ renderTable(); renderMetrics(); }

  function renderTable(){
    const tbody = $('#tbl'); tbody.innerHTML='';
    const rows = applyFilters(data.requests);
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtDateTime(r.created_at)}</td>
        <td>${escapeHtml(r.requester_name)}</td>
        <td>${escapeHtml(r.origin)}</td>
        <td>${escapeHtml(r.destination)}</td>
        <td>${badgeUrg(r.urgency)}</td>
        <td>${r.deadline_at? fmtDateTime(r.deadline_at):'<span class="muted">‚Äî</span>'}</td>
        <td>${escapeHtml(r.notes||'')}</td>
        <td>
          <select data-id="${r.id}" class="status-select">
            ${['pendente','agendado','em_rota','concluido','cancelado'].map(v=>`<option value="${v}" ${v===r.status?'selected':''}>${v}</option>`).join('')}
          </select>
        </td>
        <td>
          <button class="btn" data-act="edit" data-id="${r.id}">‚úèÔ∏è</button>
          <button class="btn" data-act="del" data-id="${r.id}">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    }
    tbody.addEventListener('change', (e)=>{
      if(e.target.matches('.status-select')){
        const id = e.target.getAttribute('data-id');
        const it = data.requests.find(x=>x.id===id);
        if(it){ it.status = e.target.value; save(); renderMetrics(); }
      }
    }, {once:true});
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return; const id = btn.getAttribute('data-id'); const it = data.requests.find(x=>x.id===id);
      if(btn.dataset.act==='del'){ if(confirm('Excluir esta solicita√ß√£o?')){ data.requests = data.requests.filter(x=>x.id!==id); save(); renderAll(); toast('Exclu√≠da.'); } }
      if(btn.dataset.act==='edit' && it){ $('#f_created_at').value = isoLocal(it.created_at); $('#f_requester').value = it.requester_name; $('#f_urgency').value = it.urgency; $('#f_origin').value = it.origin; $('#f_destination').value = it.destination; $('#f_deadline').value = isoLocal(it.deadline_at); $('#f_notes').value = it.notes||''; $('#f_status').value = it.status; data.requests = data.requests.filter(x=>x.id!==id); save(); renderAll(); }
    }, {once:true});
  }

  function renderMetrics(){
    const rows = applyFilters(data.requests);
    const today = todayStr();
    const todayCount = rows.filter(r=> (r.status!=='cancelado') && (r.created_at?.slice(0,10)===today)).length;
    const pending = rows.filter(r=> r.status==='pendente').length;
    const hot = rows.filter(r=> ['alta','critical'].includes(r.urgency) && r.status!=='cancelado').length;
    $('#m_today').textContent = todayCount; $('#m_pending').textContent = pending; $('#m_hot').textContent = hot;
  }

  function applyFilters(list){
    let out=[...list];
    const fFrom=$('#flt_from').value, fTo=$('#flt_to').value; const fReq=($('#flt_requester').value||'').toLowerCase(); const fOrg=($('#flt_origin').value||'').toLowerCase(); const fDst=($('#flt_destination').value||'').toLowerCase(); const fUrg=$('#flt_urgency').value; const fSta=$('#flt_status').value;
    if(fFrom) out=out.filter(r=> (r.created_at||'').slice(0,10)>=fFrom);
    if(fTo) out=out.filter(r=> (r.created_at||'').slice(0,10)<=fTo);
    if(fReq) out=out.filter(r=> (r.requester_name||'').toLowerCase().includes(fReq));
    if(fOrg) out=out.filter(r=> (r.origin||'').toLowerCase().includes(fOrg));
    if(fDst) out=out.filter(r=> (r.destination||'').toLowerCase().includes(fDst));
    if(fUrg) out=out.filter(r=> r.urgency===fUrg);
    if(fSta) out=out.filter(r=> r.status===fSta);
    return out;
  }

  // ======== Utils ========
  function badgeUrg(u){ const map={baixa:'u-baixa',media:'u-media',alta:'u-alta',critical:'u-critical'}; return `<span class="badge ${map[u]||'u-baixa'}">${u}</span>`; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'') }catch{ return null } }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)) }
  function clearForm(){ $$('#form-panel input, #form-panel textarea').forEach(el=>{ if(el.type!=='datetime-local') el.value=''; }); $('#f_deadline').value=''; $('#f_created_at').value=''; $('#f_urgency').value='baixa'; $('#f_status').value='pendente'; $('#f_origin').value=''; $('#f_destination').value=''; }
  function isoLocal(v){ if(!v) return ''; const d=new Date(v); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16) }
  function toast(msg){ let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{t.remove()},1400); }

  function seed(){
    const now = new Date(); const iso=(d)=>{ d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString() };
    return {version:4, requests:[
      { id: crypto.randomUUID(), created_at: iso(new Date()), requester_name:'Marcelo Gosling', urgency:'alta', origin:'Escrit√≥rio System', destination:'Atl√¢ntico Golf', deadline_at:null, notes:'Levar etiquetas', status:'pendente' },
      { id: crypto.randomUUID(), created_at: iso(new Date(now.getTime()-3600*1000*5)), requester_name:'Sigrid', urgency:'media', origin:'Galp√£o', destination:'Escrit√≥rio System', deadline_at:null, notes:'Buscar painel', status:'agendado' },
      { id: crypto.randomUUID(), created_at: iso(new Date(now.getTime()-3600*1000*28)), requester_name:'Daniele Abreu', urgency:'critical', origin:'Banco', destination:'Atl√¢ntico Golf', deadline_at: iso(new Date(now.getTime()+3600*1000*4)), notes:'Documento urgente', status:'em_rota' }
    ]};
  }
  </script>
</body>
</html>
